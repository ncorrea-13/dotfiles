#!/usr/bin/env bash

if [ -z "$BW_SESSION" ]; then
  echo "‚ùå No hay sesi√≥n activa de Bitwarden."
  echo "Inici√° sesi√≥n con: bw login o bw unlock"
  exit 1
fi

items_json=$(bw list items --session "$BW_SESSION")

if [ -z "$items_json" ] || [ "$items_json" = "[]" ]; then
  echo "‚ö†Ô∏è No se encontraron √≠tems en Bitwarden."
  exit 1
fi

selection=$(
  echo "$items_json" |
    jq -r '.[] | select(.name != null) | [.id, .name, (.login.username // "-")] | @tsv' |
    fzf --ansi --height=50% --reverse --prompt="Seleccion√° una entrada: " \
      --header="ID\tNOMBRE\tUSUARIO" |
    awk -F'\t' '{print $1}'
)

if [ -z "$selection" ]; then
  echo "‚ùå No se seleccion√≥ ning√∫n √≠tem."
  exit 0
fi

password=$(bw get password "$selection" --session "$BW_SESSION" 2>/dev/null)

if [ -z "$password" ]; then
  echo "‚ö†Ô∏è No se pudo obtener la contrase√±a para el √≠tem con ID '$selection'."
  exit 1
fi

echo -n "$password" | wl-copy
notify-send "‚úÖ Contrase√±a copiada al portapapeles para el √≠tem ID: $selection"

(sleep 5 && wl-copy <<<"" && notify-send "üßπ Portapapeles limpiado.") &
